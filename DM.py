# -*- coding: utf-8 -*-
from __future__ import annotations

import sys
import logging
from typing import List, Optional
from pydantic import BaseModel
import argparse

# ×™×™×‘×•× ××•×“×•×œ×™× ×§×™×™××™× (×‘×”× ×—×” ×©×”× ×–××™× ×™× ×‘×¤×¨×•×™×§×˜ ×©×œ×š)
from Router import RouterInput, RouterOutput, route
from Planner import PlannerInput, PlannerOutput, build_plan
from Retriever import CriteriaDocument, RetrieverInput, RetrieverOutput, retrieve
from Generator import GeneratorInput, GeneratorOutput, generate_answer


class DMOutput(BaseModel):
    """×”×¤×œ×˜ ×©×œ ×”-DM: ×ª×©×•×‘×ª ×”×–×›××•×ª ×”×¡×•×¤×™×ª ×‘×¢×‘×¨×™×ª."""
    answer: str


# --------------------------------------------------
# ğŸ”µ INLINE TEXT INPUT (×¢×¨×™×›×” ×›××Ÿ)
# ×¢×¨×•×š ××ª ×”××©×ª× ×” ×”×‘× ×× ×ª×¨×¦×” ×œ×”×–×™×Ÿ ××ª ××œ×•× ×˜×§×¡×˜ ×”××¡××š ×™×©×™×¨×•×ª ×‘×§×•×‘×¥
# ×œ×“×•×’××”:
# INLINE_TEXT = "×©××œ×” â€“ ××” ×©××š? ×ª×©×•×‘×” â€“ ×¨×××™ ××¦××¨×•×•×” | ..."
# ×× ×ª×©××™×¨ ×›-None, ××¤×©×¨ ×œ××¡×•×¨ ××ª ×”×˜×§×¡×˜ ×“×¨×š ×“×’×œ --text ×‘×©×•×¨×ª ×”×¤×§×•×“×”
# --------------------------------------------------
INLINE_TEXT: Optional[str] = """

×©××œ×” â€“ ××” ×©××š? ×ª×©×•×‘×” â€“ ×–×”×‘×” ×’×‘××™ | ×©××œ×” â€“ ×˜×œ×¤×•×Ÿ: ×ª×©×•×‘×” â€“ 0542324532 | ×©××œ×” â€“ ×ª.×–: ×ª×©×•×‘×” â€“ 054681846 | ×©××œ×” â€“ ×ª××¨×™×š ×œ×™×“×”: ×ª×©×•×‘×” â€“ 01/04/1957 | ×©××œ×” â€“ ×”×× ×”×©××œ×•×Ÿ ×¢×‘×•×¨ ×’×‘×¨ ××• ××™×©×”? ×ª×©×•×‘×” â€“ ××™×©×” | ×©××œ×” â€“ ×¡×˜×˜×•×¡ ×ª×¢×¡×•×§×ª×™: ×ª×©×•×‘×” â€“ ×‘×¤× ×¡×™×” / ×œ× ×¢×•×‘×“/×ª | ×©××œ×” â€“ ××” ×’×•×‘×” ×”×”×›× ×¡×” ×©×œ×š/×©×œ×›×? ×ª×©×•×‘×” â€“ ×œ× ×¦×•×™×Ÿ | ×©××œ×” â€“ ×”×× ××ª×”/××ª ×¡×•×‘×œ/×ª ××›××‘×™× ××• ×”×’×‘×œ×” ×‘×’×‘ ×ª×—×ª×•×Ÿ ×”××©×¤×™×¢×™× ×¢×œ ×”×ª×¤×§×•×“? ×ª×©×•×‘×” â€“ ×›×Ÿ | ×©××œ×” â€“ ×¤×¨×˜ (×’×‘/×¢××´×©): ×ª×©×•×‘×” â€“ CT ×¦×•×•××¨×™ ××¨××” ×©×™× ×•×™×™× × ×™×•×•× ×™×™×; ×‘×¢×™×™×ª ×¢××•×“ ×©×“×¨×” ×¢× ×§×™×¤×•×–×™×¡ ×•×”×¦×¨×•×ª ×§×©×™×; ×¦×¨×™×›×” × ×™×ª×•×— ××š ×—×•×©×©×ª | ×©××œ×” â€“ ×”×× ×§×™×™××™× ×›××‘×™×/×”×’×‘×œ×” ×‘×›×ª×¤×™×™× ×”××©×¤×™×¢×™× ×¢×œ ×”×ª×¤×§×•×“? ×ª×©×•×‘×” â€“ ×œ× | ×©××œ×” â€“ ×”×× ×™×© ×›××‘×™×/×”×’×‘×œ×” ×‘×‘×¨×›×™×™× ×‘×”×œ×™×›×”/×¢×œ×™×™×” ×‘××“×¨×’×•×ª? ×ª×©×•×‘×” â€“ ×œ× | ×©××œ×” â€“ ×”×× ×¢×‘×¨×ª × ×™×ª×•×— ×œ×”×—×œ×¤×ª ××¤×¨×§ ×‘×¨×š? ×ª×©×•×‘×” â€“ ×œ× | ×©××œ×” â€“ ×”×× ××•×‘×—× ×ª ×‘×¤×¨×§×™× ×¡×•×Ÿ/××¤×™×œ×¤×¡×™×” ××• ×—×•×•×™×ª ×”×ª×§×¤×™×? ×ª×©×•×‘×” â€“ ×œ× | ×©××œ×” â€“ ×”×× ×—×•×•×™×ª ××™×¨×•×¢ ××•×—×™ ×”××©×¤×™×¢ ×¢×œ ×”×ª×¤×§×•×“ (×©×™×ª×•×§ ×¤×œ×’ ×’×•×£)? ×ª×©×•×‘×” â€“ ×›×Ÿ | ×©××œ×” â€“ ×¤×¨×˜ (××™×¨×•×¢ ××•×—×™): ×ª×©×•×‘×” â€“ ×—×–×¨×” ×œ×ª×¤×§×•×“ ××œ× ×œ××¢×˜ ×¤×’×™×¢×” ×‘×–×™×›×¨×•×Ÿ ×œ×˜×•×•×— ×§×¦×¨ | ×©××œ×” â€“ ×”×× ××ª×”/××ª ×¡×•×‘×œ/×ª ××‘×¢×™×” ××•×¨×•×œ×•×’×™×ª (×‘×¨×™×—×ª ×©×ª×Ÿ)? ×ª×©×•×‘×” â€“ ×œ× ×¦×•×™×Ÿ | ×©××œ×” â€“ ×”×× ××•×‘×—× ×ª ×‘××—×œ×” ×¨××•××˜×•×œ×•×’×™×ª (×œ××©×œ FMF/×˜×¨×©×ª × ×¤×•×¦×”/×§×¨×•×”×Ÿ/×¦×œ×™××§/×–××‘×ª)? ×ª×©×•×‘×” â€“ ×œ× | ×©××œ×” â€“ ×”×× ××•×‘×—× ×ª ×‘××—×œ×ª ×¡×¨×˜×Ÿ? ×ª×©×•×‘×” â€“ ×œ× | ×©××œ×” â€“ ×”×× ×§×™×™××•×ª ×‘×¢×™×•×ª ×¨×¤×•××™×•×ª × ×•×¡×¤×•×ª ×©×œ× ×¦×•×™× ×•? ×ª×©×•×‘×” â€“ ×›×Ÿ | ×©××œ×” â€“ ×¤×¨×˜×™× ×—×•×¤×©×™×™×: ×ª×©×•×‘×” â€“ ×¡×›×¨×ª ×‘×˜×™×¤×•×œ ×¤×•××™ | ×©××œ×” â€“ ×”×× ×”×œ×§×•×— ×–×§×•×§ ×œ×¢×–×¨×” ×‘×œ×‘×™×©×” ×•×‘×”×ª×¤×©×˜×•×ª? ×ª×©×•×‘×” â€“ ×–×§×•×§ ×œ×¢×–×¨×” ×—×œ×§×™×ª (×–×§×•×§ ×œ×”×›×•×•× ×”/×¢×–×¨×” ××•×¢×˜×”) | ×©××œ×” â€“ ×”×× ×”×œ×§×•×— ×–×§×•×§ ×œ×¢×–×¨×” ×‘×¨×—×¦×”? ×ª×©×•×‘×” â€“ ×–×§×•×§ ×œ×¢×–×¨×” ×—×œ×§×™×ª (×¡×™×•×¢ ×‘×—×œ×§ ××¤×¢×•×œ×•×ª ×”×¨×—×¦×”) | ×©××œ×” â€“ ×”×× ×”×œ×§×•×— ×–×§×•×§ ×œ×¢×–×¨×” ×‘××›×™×œ×”/×©×ª×™×™×” ××• ×‘×”×›× ×ª/×”×’×©×ª ×”××•×›×œ? ×ª×©×•×‘×” â€“ ×–×§×•×§ ×œ×¢×–×¨×” ×—×œ×§×™×ª | ×©××œ×” â€“ ×”×× ×”×œ×§×•×— ×–×§×•×§ ×œ×¢×–×¨×” ×‘× ×™×™×“×•×ª ×‘×ª×•×š ×”×‘×™×ª? ×ª×©×•×‘×” â€“ ×¢×¦×××™ ×œ×—×œ×•×˜×™×Ÿ; ××¡×•×’×œ ×œ× ×•×¢ ×‘×‘×™×ª ×œ×œ× ×¢×–×¨×” (×’× ×œ×œ× ×›×œ×™ ×¢×–×¨) | ×©××œ×” â€“ ×”×× ×”×œ×§×•×— ×©×•×œ×˜ ×¢×œ ×¡×•×’×¨×™×•? ×ª×©×•×‘×” â€“ ×©×œ×™×˜×” ×—×œ×§×™×ª; ×©×™××•×© ×‘××•×¦×¨×™ ×¡×¤×™×’×” | ×©××œ×” â€“ ×”×× ×”×œ×§×•×— ×–×§×•×§ ×œ×”×©×’×—×” ×œ×× ×™×¢×ª ×¡×›× ×” ×œ×¢×¦××•/×œ××—×¨×™×? ×ª×©×•×‘×” â€“ ×–×§×•×§ ×œ×”×©×’×—×” ×—×œ×§×™×ª (×œ×¢×™×ª×™×) | ×©××œ×” â€“ ×”×× ×§×™×™××™× ×‘×‘×™×ª ×¢×–×¨×™ × ×™×™×“×•×ª/×¨×—×¦×” (×›×™×¡× ×¨×—×¦×”/×¡×¤×¡×œ ×œ××§×œ×—×ª/×›×™×¡× ×’×œ×’×œ×™×/×”×œ×™×›×•×Ÿ)? ×ª×©×•×‘×” â€“ ×œ× ×¤×•×¨×˜ (×™×™×ª×›×Ÿ ×©×§×™×™× ××—×“ ××”× ×´×œ) | ×©××œ×” â€“ ×”×× ×”×œ×§×•×— ××©×ª××© ×‘×¢×–×¨ ××™×©×™ ×›×œ×©×”×•? ×ª×©×•×‘×” â€“ ×œ× ××©×ª××© ×‘××£ ×¢×–×¨ ××™×©×™.    
    


"""


def run_pipeline_with_text(document_text: str) -> DMOutput:
    """
    ××¤×¢×™×œ ××ª ×”×¤×™×™×¤×œ×™×™×Ÿ ×”××ª×—×™×œ ×-ROUTER ×›×©×”×§×œ×˜ ×”×•× ××—×¨×•×–×ª ×˜×§×¡×˜ ××œ××” (document_text),
    ×œ×œ× ×©×œ×‘ Parser ×•×œ×œ× ×§×¨×™××ª ×§×‘×¦×™×.
    """
    logger = logging.getLogger(__name__)

    # ×•×œ×™×“×¦×™×” ×‘×¡×™×¡×™×ª ×œ×˜×§×¡×˜ ×©×”×•×–×Ÿ
    if document_text is None or not document_text.strip():
        logger.error("×”×˜×§×¡×˜ ×©×¡×•×¤×§ ×¨×™×§ ××• None.")
        sys.exit(1)

    # ×©×œ×‘ 1 (ROUTER): ×–×™×”×•×™ ×§×˜×’×•×¨×™×•×ª ×¨×œ×•×•× ×˜×™×•×ª
    try:
        router_input = RouterInput(document_text=document_text)
        router_output: RouterOutput = route(router_input)
    except Exception as e:
        logger.error("×©×’×™××” ×‘×©×œ×‘ ×”-Router: %s", e)
        sys.exit(1)

    if not getattr(router_output, 'categories', None):
        logger.error("×œ× × ××¦××” ×§×˜×’×•×¨×™×” ××ª××™××” ×‘××¡××š.")
        sys.exit(1)

    selected_category = router_output.categories[0]

    # ×©×œ×‘ 2 (PLANNER): ×‘× ×™×™×ª ×©××™×œ×ª×•×ª ×§×¨×™×˜×¨×™×•× ×™× ×•×©××œ×ª ×–×›××•×ª
    try:
        planner_input = PlannerInput(
            category=selected_category,
            document_text=document_text
        )
        planner_output: PlannerOutput = build_plan(planner_input)
    except Exception as e:
        logger.error("×©×’×™××” ×‘×©×œ×‘ ×”-Planner: %s", e)
        sys.exit(1)

    # ×©×œ×‘ 3 (RETRIEVER): ×©×œ×™×¤×ª ×§×˜×¢×™ ×§×¨×™×˜×¨×™×•× ×™×
    try:
        # TODO: ×”×˜××¢×ª ×˜×¢×™× ×” ×××™×ª×™×ª ×©×œ ××¡××›×™ ×”×§×¨×™×˜×¨×™×•× ×™× ××”××¢×¨×›×ª ×©×œ×š
        criteria_docs: List[CriteriaDocument] = []
        retriever_input = RetrieverInput(
            criteria_queries=planner_output.criteria_queries,
            criteria_documents=criteria_docs
        )
        retriever_output: RetrieverOutput = retrieve(retriever_input)
    except Exception as e:
        logger.error("×©×’×™××” ×‘×©×œ×‘ ×”-Retriever: %s", e)
        sys.exit(1)

    # ×©×œ×‘ 4 (GENERATOR): ×”×¤×§×ª ×ª×©×•×‘×” ×¡×•×¤×™×ª ×‘×¢×‘×¨×™×ª
    try:
        generator_input = GeneratorInput(
            question=planner_output.question,
            patient_text=document_text,
            retrieved_sections=retriever_output.retrieved_sections
        )
        generator_output: GeneratorOutput = generate_answer(generator_input)
    except Exception as e:
        logger.error("×©×’×™××” ×‘×©×œ×‘ ×”-Generator: %s", e)
        sys.exit(1)

    return DMOutput(answer=generator_output.answer)


def main():
    logging.basicConfig(level=logging.INFO)
    parser = argparse.ArgumentParser(description="Decision Maker pipeline (Router-first, inline text or --text)")
    parser.add_argument("--text", type=str, help="××—×¨×•×–×ª ×”×˜×§×¡×˜ ×”××œ××” ×©×œ ×”××¡××š (document_text)")
    args = parser.parse_args()


    # ×¢×“×™×¤×•×ª: ×“×’×œ CLI --text; ×× ×œ× × ××¡×¨, × ×©×ª××© ×‘-INLINE_TEXT ×©×‘×§×•×‘×¥
    document_text: Optional[str] = args.text if args.text else INLINE_TEXT

    if document_text is None:
        print("×™×© ×œ×¡×¤×§ ×˜×§×¡×˜ ×“×¨×š --text ××• ×œ×”×’×“×™×¨ INLINE_TEXT ×‘×§×•×‘×¥.")
        sys.exit(1)

    result = run_pipeline_with_text(document_text=document_text)
    print(result.answer)


if __name__ == "__main__":
    main()
